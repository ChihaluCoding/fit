<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly History | STRIDE-X</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen bg-slate-100 flex items-center justify-center p-6">
    <div class="max-w-3xl w-full glass-card rounded-[2.5rem] p-10 space-y-6">
        <div class="flex items-center justify-between">
            <h1 class="font-outfit text-3xl font-black tracking-[0.3em] uppercase text-slate-800">Monthly History</h1>
            <a href="index.html" class="px-4 py-2 rounded-2xl bg-slate-900 text-white text-xs font-black uppercase tracking-[0.3em] hover:bg-blue-600">Back</a>
        </div>
        <div class="text-slate-500 font-bold uppercase tracking-[0.3em] text-xs">
            月ごとの体重推移と記録数を表示
        </div>
        <div id="monthHistoryList" class="space-y-3"></div>
        <!-- 月別の体重推移グラフを表示するエリア -->
        <div class="mt-6 bg-white/70 border border-slate-100 rounded-2xl p-4">
            <!-- グラフの見出し -->
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-black uppercase tracking-[0.3em] text-slate-400">Monthly Weight Graph</p>
                <span id="monthGraphLabel" class="text-xs font-black uppercase tracking-[0.3em] text-slate-400">--</span>
            </div>
            <!-- 月別推移グラフの描画領域 -->
            <svg id="monthGraph" viewBox="0 0 600 200" class="w-full h-48"></svg>
            <!-- グラフの補足説明 -->
            <p id="monthGraphNote" class="text-xs font-bold text-slate-400 mt-3">月ごとの最新体重を線で結びます</p>
        </div>
    </div>

    <script>
        // 月別履歴の描画領域を取得する
        const listEl = document.getElementById('monthHistoryList');
        // 体重ログを取得する
        const logs = JSON.parse(localStorage.getItem('stridex_weight_logs')) || [];

        // 月キーを作成する
        function getMonthKey(dateString) {
            const d = new Date(dateString);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        // 月ごとの集計を作成する
        function buildMonthlySummary(sourceLogs) {
            const summaryMap = {};
            sourceLogs.forEach(log => {
                const key = getMonthKey(log.date);
                if(!summaryMap[key]) {
                    summaryMap[key] = { first: log.weight, last: log.weight, count: 0 };
                }
                summaryMap[key].last = log.weight;
                summaryMap[key].count += 1;
            });
            return summaryMap;
        }

        // 月別のサマリーとキーを取得する
        function getMonthlySummaryData() {
            if(!Array.isArray(logs) || logs.length === 0) return { keys: [], summaryMap: {} };
            const sortedLogs = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
            const summaryMap = buildMonthlySummary(sortedLogs);
            const keys = Object.keys(summaryMap).sort((a, b) => a.localeCompare(b));
            return { keys, summaryMap };
        }

        // 画面に月別履歴を描画する
        function renderMonthlyHistory() {
            const data = getMonthlySummaryData();
            if(data.keys.length === 0) {
                listEl.innerHTML = '<div class="text-slate-400 font-bold text-center">記録がありません</div>';
                return;
            }
            listEl.innerHTML = data.keys.map(key => {
                const entry = data.summaryMap[key];
                return `
                    <div class="flex items-center justify-between bg-white/80 border border-slate-100 rounded-2xl px-4 py-3">
                        <div>
                            <div class="text-xs font-black text-slate-400 uppercase tracking-[0.3em]">${key}</div>
                            <div class="text-sm font-bold text-slate-500">記録数 ${entry.count} 件</div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-black text-slate-900">${entry.first} kg → ${entry.last} kg</div>
                            <div class="text-xs font-bold text-slate-400">初回 → 最新</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 月別の体重推移グラフを描画する
        function renderMonthlyGraph() {
            const graphEl = document.getElementById('monthGraph');
            const labelEl = document.getElementById('monthGraphLabel');
            const noteEl = document.getElementById('monthGraphNote');
            if(!graphEl || !labelEl || !noteEl) return;
            const data = getMonthlySummaryData();
            if(data.keys.length === 0) {
                graphEl.innerHTML = '<text x="300" y="100" text-anchor="middle" fill="#94a3b8" font-size="14">記録がありません</text>';
                labelEl.textContent = '--';
                noteEl.textContent = '体重を記録するとグラフが表示されます';
                return;
            }
            const points = data.keys.map((key, index) => {
                const entry = data.summaryMap[key];
                return { label: key, value: parseFloat(entry.last), index };
            });
            const values = points.map(p => p.value);
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const range = Math.max(0.1, maxValue - minValue);
            const paddingX = 40;
            const paddingY = 20;
            const width = 600 - paddingX * 2;
            const height = 200 - paddingY * 2;
            const coords = points.map(p => {
                const x = paddingX + ((p.index) / (points.length - 1 || 1)) * width;
                const y = paddingY + (1 - (p.value - minValue) / range) * height;
                return { x, y };
            });
            const path = coords.map((p, idx) => `${idx === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
            labelEl.textContent = `${data.keys[0]} 〜 ${data.keys[data.keys.length - 1]}`;
            graphEl.innerHTML = `
                <line x1="${paddingX}" y1="${paddingY}" x2="${paddingX}" y2="${paddingY + height}" stroke="#e2e8f0" stroke-width="2"></line>
                <line x1="${paddingX}" y1="${paddingY + height}" x2="${paddingX + width}" y2="${paddingY + height}" stroke="#e2e8f0" stroke-width="2"></line>
                <path d="${path}" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
                ${coords.map(p => `<circle cx="${p.x}" cy="${p.y}" r="4" fill="#0ea5e9"></circle>`).join('')}
                <text x="${paddingX}" y="${paddingY - 6}" fill="#94a3b8" font-size="12">${maxValue.toFixed(1)} kg</text>
                <text x="${paddingX}" y="${paddingY + height + 18}" fill="#94a3b8" font-size="12">${minValue.toFixed(1)} kg</text>
            `;
            noteEl.textContent = '月ごとの最新体重を線で結びます';
        }

        // 初期描画を実行する
        renderMonthlyHistory();
        renderMonthlyGraph();
    </script>
</body>
</html>
