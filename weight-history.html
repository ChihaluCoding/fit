<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weight History | STRIDE-X</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen bg-slate-100 flex items-center justify-center p-6">
    <div class="max-w-3xl w-full glass-card rounded-[2.5rem] p-10 space-y-6">
        <div class="flex items-center justify-between">
            <h1 class="font-outfit text-3xl font-black tracking-[0.3em] uppercase text-slate-800">Weight Calendar</h1>
            <a href="index.html" class="px-4 py-2 rounded-2xl bg-slate-900 text-white text-xs font-black uppercase tracking-[0.3em] hover:bg-blue-600">Back</a>
        </div>
        <div class="flex items-center justify-between text-slate-500 font-bold uppercase tracking-[0.3em]">
            <button id="prevMonth" class="px-3 py-2 rounded-2xl bg-slate-200 text-slate-600 text-xs hover:bg-slate-300">&lt;</button>
            <span id="monthLabel"></span>
            <button id="nextMonth" class="px-3 py-2 rounded-2xl bg-slate-200 text-slate-600 text-xs hover:bg-slate-300">&gt;</button>
        </div>
        <div id="historyList" class="grid grid-cols-7 gap-3"></div>
        <small class="text-slate-400 uppercase tracking-[0.3em] block text-center">1か月分の体重推移を表示</small>
        <!-- 体重推移グラフの表示エリア -->
        <div class="mt-6 bg-white/70 border border-slate-100 rounded-2xl p-4">
            <!-- グラフの見出し -->
            <div class="flex items-center justify-between mb-3">
                <p class="text-xs font-black uppercase tracking-[0.3em] text-slate-400">Weight Graph</p>
                <span id="graphLabel" class="text-xs font-black uppercase tracking-[0.3em] text-slate-400">--</span>
            </div>
            <!-- SVGグラフの描画領域 -->
            <svg id="weightGraph" viewBox="0 0 600 200" class="w-full h-48"></svg>
            <!-- グラフの説明 -->
            <p id="graphNote" class="text-xs font-bold text-slate-400 mt-3">記録がある日だけ線で結びます</p>
        </div>
    </div>

    <script>
        // カレンダー描画対象のコンテナを取得する
        const container = document.getElementById('historyList');
        // 月表示ラベルを取得する
        const monthLabel = document.getElementById('monthLabel');
        // 前月ボタンを取得する
        const prevBtn = document.getElementById('prevMonth');
        // 翌月ボタンを取得する
        const nextBtn = document.getElementById('nextMonth');
        // 体重ログを保持する配列を用意する
        let logs = JSON.parse(localStorage.getItem('stridex_weight_logs')) || [];
        // 日付キーと体重を紐付けるマップを保持する
        let logMap = buildLogMap(logs);

        // 表示対象の月を保持する
        let currentDate = new Date();

        // ログ配列から日付マップを作成する
        function buildLogMap(sourceLogs) {
            return sourceLogs.reduce((acc, log) => {
                acc[log.date] = log.weight;
                return acc;
            }, {});
        }

        // 体重ログを日付降順に並べて整理する
        function sortLogsByDate(sourceLogs) {
            return sourceLogs.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // 今日の設定体重を更新する
        function syncConfigWeightIfToday(dateKey, weightValue) {
            const todayKey = new Date().toISOString().split('T')[0]; // 今日の日付キーを取得する
            if(dateKey !== todayKey) return; // 今日以外は設定体重を更新しない
            const cfg = JSON.parse(localStorage.getItem('stridex_config')) || {}; // 既存設定を取得する
            cfg.weight = weightValue; // 設定体重を最新の入力値に更新する
            localStorage.setItem('stridex_config', JSON.stringify(cfg)); // 設定を保存する
        }

        // 体重ログを保存して状態を更新する
        function saveLogs(nextLogs) {
            logs = sortLogsByDate(nextLogs); // 保存前に日付降順で整列する
            localStorage.setItem('stridex_weight_logs', JSON.stringify(logs));
            logMap = buildLogMap(logs);
        }

        // 指定月のカレンダーを描画する
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const start = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0).getDate();
            const startWeekDay = start.getDay();
            const monthName = start.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long' });
            monthLabel.textContent = monthName;

            const cells = [];
            for(let i = 0; i < startWeekDay; i++) {
                cells.push('<div class="h-24 rounded-2xl bg-transparent"></div>');
            }

            for(let day = 1; day <= lastDay; day++) {
                const dateObj = new Date(year, month, day);
                const iso = dateObj.toISOString().split('T')[0];
                const weight = logMap[iso];
                const editLabel = weight ? '編集' : '記録'; // 体重がある場合は編集、無い場合は記録と表示する
                const editButton = `<button type="button" data-edit-date="${iso}" class="text-[0.6rem] font-black uppercase tracking-[0.3em] text-blue-600 hover:text-blue-800">${editLabel}</button>`; // 体重入力の編集ボタンを作る
                const deleteButton = weight
                    ? `<button type="button" data-delete-date="${iso}" class="text-[0.6rem] font-black uppercase tracking-[0.3em] text-rose-500 hover:text-rose-700">削除</button>`
                    : '';
                cells.push(`
                    <div class="h-24 rounded-2xl bg-white border border-slate-100 flex flex-col justify-between p-3">
                        <span class="text-xs font-black text-slate-400 uppercase tracking-[0.3em]">${('0' + day).slice(-2)}</span>
                        <span class="text-xl font-black ${weight ? 'text-slate-900' : 'text-slate-300'}">${weight ? weight + ' kg' : '--'}</span>
                        <div class="flex items-center justify-between">
                            ${editButton}
                            ${deleteButton}
                        </div>
                    </div>
                `);
            }

            container.innerHTML = cells.join('');
        }

        // 月間の体重推移データを抽出する
        function buildMonthSeries(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const lastDay = new Date(year, month + 1, 0).getDate();
            const points = [];
            for(let day = 1; day <= lastDay; day++) {
                const dateObj = new Date(year, month, day);
                const iso = dateObj.toISOString().split('T')[0];
                const weight = logMap[iso];
                if(weight !== undefined) {
                    points.push({ day, weight: parseFloat(weight) });
                }
            }
            return points;
        }

        // 体重推移グラフを描画する
        function renderGraph(date) {
            const svg = document.getElementById('weightGraph');
            const label = document.getElementById('graphLabel');
            const note = document.getElementById('graphNote');
            if(!svg || !label || !note) return;
            const points = buildMonthSeries(date);
            const monthText = date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit' });
            label.textContent = monthText;
            if(points.length === 0) {
                svg.innerHTML = '<text x="300" y="100" text-anchor="middle" fill="#94a3b8" font-size="14">記録がありません</text>';
                note.textContent = '体重を記録するとグラフが表示されます';
                return;
            }
            const weights = points.map(p => p.weight);
            const minWeight = Math.min(...weights);
            const maxWeight = Math.max(...weights);
            const range = Math.max(0.1, maxWeight - minWeight);
            const paddingX = 40;
            const paddingY = 20;
            const width = 600 - paddingX * 2;
            const height = 200 - paddingY * 2;
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const coords = points.map(p => {
                const x = paddingX + ((p.day - 1) / (lastDay - 1 || 1)) * width;
                const y = paddingY + (1 - (p.weight - minWeight) / range) * height;
                return { x, y, weight: p.weight };
            });
            const path = coords.map((p, idx) => `${idx === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
            const minLabel = minWeight.toFixed(1);
            const maxLabel = maxWeight.toFixed(1);
            svg.innerHTML = `
                <line x1="${paddingX}" y1="${paddingY}" x2="${paddingX}" y2="${paddingY + height}" stroke="#e2e8f0" stroke-width="2"></line>
                <line x1="${paddingX}" y1="${paddingY + height}" x2="${paddingX + width}" y2="${paddingY + height}" stroke="#e2e8f0" stroke-width="2"></line>
                <path d="${path}" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
                ${coords.map(p => `<circle cx="${p.x}" cy="${p.y}" r="4" fill="#0ea5e9"></circle>`).join('')}
                <text x="${paddingX}" y="${paddingY - 6}" fill="#94a3b8" font-size="12">${maxLabel} kg</text>
                <text x="${paddingX}" y="${paddingY + height + 18}" fill="#94a3b8" font-size="12">${minLabel} kg</text>
            `;
            note.textContent = '記録がある日だけ線で結びます';
        }

        // クリックされた削除ボタンの対象ログを削除する
        container.addEventListener('click', (event) => {
            const editButton = event.target.closest('[data-edit-date]');
            if(editButton) {
                const dateKey = editButton.getAttribute('data-edit-date'); // 編集対象の日付キーを取得する
                if(!dateKey) return;
                const currentValue = logMap[dateKey]; // 既存の体重を取得する
                const inputValue = window.prompt('体重を入力してください (kg)', currentValue !== undefined ? currentValue : ''); // 入力ダイアログを表示する
                if(inputValue === null) return; // キャンセル時は処理しない
                const nextValue = parseFloat(inputValue); // 入力値を数値に変換する
                if(!nextValue || nextValue <= 0) {
                    window.alert('正しい体重を入力してください。'); // 不正値の場合は警告する
                    return;
                }
                const existingIndex = logs.findIndex(log => log.date === dateKey); // 既存ログの位置を取得する
                if(existingIndex >= 0) {
                    logs[existingIndex].weight = nextValue; // 既存記録を更新する
                } else {
                    logs.push({ date: dateKey, weight: nextValue }); // 新規記録を追加する
                }
                syncConfigWeightIfToday(dateKey, nextValue); // 今日の体重なら設定にも反映する
                saveLogs(logs); // ログを保存して状態を更新する
                renderCalendar(currentDate); // カレンダー表示を更新する
                renderGraph(currentDate); // グラフも更新する
                return;
            }
            const button = event.target.closest('[data-delete-date]');
            if(!button) return;
            const dateKey = button.getAttribute('data-delete-date');
            if(!dateKey) return;
            const nextLogs = logs.filter(log => log.date !== dateKey);
            saveLogs(nextLogs);
            renderCalendar(currentDate);
            renderGraph(currentDate);
        });

        // 前月ボタンで表示月を切り替える
        prevBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
            renderGraph(currentDate);
        });

        // 翌月ボタンで表示月を切り替える
        nextBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
            renderGraph(currentDate);
        });

        // 初期表示を描画する
        renderCalendar(currentDate);
        renderGraph(currentDate);
    </script>
</body>
</html>
